<!DOCTYPE html>
<html>
<head>
  <title>Nordollars Bank</title>
</head>
<body>
  <h1>Nordollars Bank Login</h1>

  <label>Username: <input type="text" id="username"></label><br>
  <label>PIN: <input type="password" id="pin"></label><br>
  <button id="loginBtn">Login</button>
  <!--
  New account button removed for security reasons after someone broke honor code and put too much money in and spread around.
  
  <button id="newAccountBtn" onclick="window.location.href='createAccount.html'">Create Account</button>
  -->

  <div id="output"></div>

  <script>
    const SUPABASE_URL = "https://fjgbygqbwxtldeptngyq.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZ2J5Z3Fid3h0bGRlcHRuZ3lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MzkyOTUsImV4cCI6MjA4NTExNTI5NX0.BlPaxorKFOUhz4Y2ahtoUvlDJTaMna6cSNX6ncBrlYk"

    const loginBtn = document.getElementById("loginBtn")
    loginBtn.addEventListener("click", async () => {
      const username = document.getElementById("username").value
      const pin = document.getElementById("pin").value

    // fetch accounts
    const res = await fetch(`${SUPABASE_URL}/rest/v1/accounts?name=eq.${encodeURIComponent(username)}&select=id,name,balance,pin,is_bank`,
    {
        headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`
        }
    });

      const data = await res.json()

      if(data.length === 0) {
        document.getElementById("output").textContent = "User not found"
        return
      }

      const user = data[0]

      if(user.pin === pin) {
        // temp output for demo
        document.getElementById("output").textContent = `Correct Login.`

        // Successful login, go to account dashboard
        localStorage.setItem("nordollar_user", JSON.stringify({
        username: user.name,
        balance: user.balance,
        account_id: user.id,
        is_bank: user.is_bank
        }));

        window.location.href = "account.html";

      } else {
        document.getElementById("output").textContent = "Incorrect PIN"
      }
    })
  </script>
</body>
</html>
