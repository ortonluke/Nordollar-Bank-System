<!DOCTYPE html>
<html>
<head>
  <title>Nordollars Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <section class="hero is-brand">
    <div class="hero-body">
      <div class="container has-text-centered">
        <p class="badge mb-3">Nordollars Bank</p>
        <h1 class="title is-3 nordollars-header">Secure Login</h1>
        <p class="subtitle is-6">Access your Nordollars account</p>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="card is-soft form-card">
        <div class="card-content">
          <h2 class="title is-4">Sign in</h2>
          <p class="helper-text mb-4">Enter your username and PIN to continue.</p>

          <div class="field">
            <label class="label">Username</label>
            <div class="control">
              <input class="input" type="text" id="username" placeholder="e.g. Alex">
            </div>
          </div>

          <div class="field">
            <label class="label">PIN</label>
            <div class="control">
              <input class="input" type="password" id="pin" placeholder="••••">
            </div>
          </div>

          <div class="field is-grouped is-grouped-right">
            <div class="control">
              <button class="button is-brand" id="loginBtn">Login</button>
            </div>
            <!--
            Removed "Create Account" button for after a "security breach"
            <div class="control">
              <button class="button is-light" id="newAccountBtn" onclick="window.location.href='createAccount.html'">Create Account</button>
            </div>
            -->
          </div>

          <div id="output" class="notification is-light mt-4" style="display:none;"></div>
        </div>
      </div>
    </div>
  </section>

  <script>
    const SUPABASE_URL = "https://fjgbygqbwxtldeptngyq.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZ2J5Z3Fid3h0bGRlcHRuZ3lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MzkyOTUsImV4cCI6MjA4NTExNTI5NX0.BlPaxorKFOUhz4Y2ahtoUvlDJTaMna6cSNX6ncBrlYk"

    const loginBtn = document.getElementById("loginBtn")
    loginBtn.addEventListener("click", async () => {
      const username = document.getElementById("username").value
      const pin = document.getElementById("pin").value

    // fetch accounts
    const res = await fetch(`${SUPABASE_URL}/rest/v1/accounts?name=eq.${encodeURIComponent(username)}&select=id,name,balance,pin,is_bank`,
    {
        headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`
        }
    });

      const data = await res.json()

      if(data.length === 0) {
        const output = document.getElementById("output")
        output.textContent = "User not found"
        output.style.display = "block"
        return
      }

      const user = data[0]

      if(user.pin === pin) {
        // temp output for demo
        const output = document.getElementById("output")
        output.textContent = "Correct Login."
        output.classList.remove("is-danger")
        output.classList.add("is-success")
        output.style.display = "block"

        // Successful login, go to account dashboard
        localStorage.setItem("nordollar_user", JSON.stringify({
        username: user.name,
        balance: user.balance,
        account_id: user.id,
        is_bank: user.is_bank
        }));

        window.location.href = "account.html";

      } else {
        const output = document.getElementById("output")
        output.textContent = "Incorrect PIN"
        output.classList.add("is-danger")
        output.style.display = "block"
      }
    })
  </script>
</body>
</html>
