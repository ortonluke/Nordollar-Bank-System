<!DOCTYPE html>
<html>
<head>
  <title>Nordollars Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <!--
    <p>Page Not Found</p>
    -->
    
  <section class="hero is-brand">
    <div class="hero-body">
      <div class="container has-text-centered">
        <p class="badge mb-3">Nordollars Bank</p>
        <h1 class="title is-3 nordollars-header">Create Account</h1>
        <p class="subtitle is-6">Open a new Nordollars account in minutes</p>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="card is-soft form-card">
        <div class="card-content">
          <h2 class="title is-4">New account details</h2>
          <p class="helper-text mb-4">Choose a username, PIN, and starting balance.</p>

          <div class="field">
            <label class="label">Username</label>
            <div class="control">
              <input class="input" type="text" id="username" placeholder="e.g. Alex">
            </div>
          </div>

          <div class="field">
            <label class="label">PIN</label>
            <div class="control">
              <input class="input" type="password" id="pin" placeholder="Minimum 4 digits">
            </div>
          </div>

          <div class="field">
            <label class="label">Initial Balance</label>
            <div class="control">
              <input class="input" type="number" id="initialBalance" min="0" placeholder="0">
            </div>
          </div>

          <div class="field is-grouped is-grouped-right">
            <div class="control">
              <button class="button is-brand" id="newAccountBtn">Create Account</button>
            </div>
            <div class="control">
              <button class="button is-light" onclick="window.location.href='index.html'">Back to Login</button>
            </div>
          </div>

          <div id="output" class="notification is-light mt-4" style="display:none;"></div>
        </div>
      </div>
    </div>
  </section>
</body>
<script>
    const SUPABASE_URL = "https://fjgbygqbwxtldeptngyq.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZ2J5Z3Fid3h0bGRlcHRuZ3lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MzkyOTUsImV4cCI6MjA4NTExNTI5NX0.BlPaxorKFOUhz4Y2ahtoUvlDJTaMna6cSNX6ncBrlYk"

  const newAccountBtn = document.getElementById("newAccountBtn");
  const output = document.getElementById("output"); // Add a <p id="output"></p> for messages

  newAccountBtn.addEventListener("click", async () => {
    const username = document.getElementById("username").value.trim();
    const pin = document.getElementById("pin").value.trim();
    const initialBalance = Number(document.getElementById("initialBalance").value);

    if (!username || pin.length < 4 || initialBalance < 0) {
      output.textContent = "Invalid input: username required, PIN ≥4, balance ≥0";
      output.style.display = "block";
      output.classList.add("is-danger");
      return;
    }

    try {
      // Check username exists
      const resCheck = await fetch(`${SUPABASE_URL}/rest/v1/accounts?name=eq.${encodeURIComponent(username)}`, {
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
      });
      const dataCheck = await resCheck.json();
      if (dataCheck.length > 0) {
        output.textContent = "Username already taken";
        output.style.display = "block";
        output.classList.add("is-danger");
        return;
      }

      // Insert new account
      const resInsert = await fetch(`${SUPABASE_URL}/rest/v1/accounts`, {
        method: "POST",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name: username,
          pin: pin,
          balance: initialBalance
        })
      });

      if (!resInsert.ok) {
        const errText = await resInsert.text();
        console.error(errText);
        output.textContent = "Failed to create account — check console";
        output.style.display = "block";
        output.classList.add("is-danger");
        return;
      }

      output.textContent = "Account created successfully! Redirecting to login...";
      output.style.display = "block";
      output.classList.remove("is-danger");
      output.classList.add("is-success");
      setTimeout(() => window.location.href = "index.html", 2000);

    } catch (err) {
      console.error(err);
      output.textContent = "Unexpected error — check console";
      output.style.display = "block";
      output.classList.add("is-danger");
    }
  });
</script>
</html>